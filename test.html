<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>查看/导出评审</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="./resources/layui/css/layui.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/layui-soul-table/docs/soulTable.css" media="all" />

  <!-- jquery文件必须写在其他js文件之前,否则会报错!! -->
  <script src="./js/jquery-3.5.1.min.js"></script>
  <script src="./resources/layui/layui.js"></script>

  <style>

  </style>
</head>

<body>
  <div id="header"></div>
  <div class="layui-card">
    <div class="layui-card-body">
      <fieldset class="layui-elem-field site-demo-button" style="margin-top: 30px;">
        <div style="margin: 10px" id="projectItems"></div>
        <hr />
        <div style="margin: 10px" id="markTimes">
          <span>初审/终审：</span>
          <button type="button" class="layui-btn reviewChange" reviewId="1">初审</button>
          <button type="button" class="layui-btn layui-btn-primary reviewChange" reviewId="2">终审</button>
        </div>
        <hr />
        <div style="margin: 10px" id="group1Items">
        </div>
      </fieldset>

      <table id="myTable" lay-filter="myTable" style=" width: 100%;"></table>
    </div>
  </div>

  <script>
    layui.config({
      base: './js/ext/'
    }).extend({
      soulTable: 'soulTable'
    });

    layui.use(['form', 'table', 'soulTable'], function () {
      var table = layui.table,
        soulTable = layui.soulTable;
      var markTimes = 1;
      var projectId;
      var groupId;
      var cols = [];
      var scoreItem = [];

      $.ajax({
        url: "/fjaisc/project/myJudgeTree",
        type: "GET",
        data: { "markTimes": markTimes },
        datatype: "json",
        async: false,
        success: function (data) {
          if (data.code == 200) {
            var projectList = data.data;
            var projectEls = ['<span>项目：</span>'];
            $.each(projectList, function (index, item) {
              if (index == 0) {
                projectId = item.id;
                projectEls.push('<button type="button" class="layui-btn changeProject" projectId="' + item.id + '">' + item.name + '</button>');
                initGroupNav(item.children);
                initTableHeader(projectId);
              } else {
                projectEls.push('<button type="button" class="layui-btn layui-btn-primary" projectId="' + item.id + '">' + item.name + '</button>')
              }
            })
            $("#projectItems").html(projectEls.join(''));

            $(".changeProject").click(function () {
              var tEl = $(this);
              var t = tEl.attr("projectId");
              $(".changeProject").addClass("layui-btn-primary");
              tEl.removeClass("layui-btn-primary");
              if (t) {
                projectId = t;
                for (var i = 0; i < projectList.length; i++) {
                  if (projectList[i].id == projectId) {
                    initGroupNav(projectList[i].children);
                    initTableHeader(projectId);
                  }
                }
              }
            });
            $(".reviewChange").click(function () {
              var tEl = $(this);
              var t = tEl.attr("reviewId");
              $(".reviewChange").addClass("layui-btn-primary");
              tEl.removeClass("layui-btn-primary");
              if (t) {
                markTimes = t;
                initTableHeader(projectId);
              }
            });
          }
        }
      });

      function initGroupNav(items) {
        var groupEls = ['<span>年级组：</span>'];
        $.each(items, function (gindex, gitem) {
          if (gindex == 0) {
            groupId = gitem.id;
            groupEls.push('<button type="button" class="layui-btn groupChange" groupId="' + gitem.id + '">' + gitem.name + '</button>');
          } else {
            groupEls.push('<button type="button" class="layui-btn layui-btn-primary groupChange" groupId="' + gitem.id + '">' + gitem.name + '</button>')
          }
          $("#group1Items").html(groupEls.join(''));
        });
        $(".groupChange").click(function () {
          var tEl = $(this);
          var t = tEl.attr("groupId");
          $(".groupChange").addClass("layui-btn-primary");
          tEl.removeClass("layui-btn-primary");
          if (t) {
            groupId = t;
            initTableHeader(projectId);
          }
        });
      }

      function initTableHeader(projectId) {
        $.ajax({
          url: "/fjaisc/group/list",
          type: "GET",
          async: false,
          data: { "parentId": projectId },
          datatype: "json",
          success: function (data) {
            var titleContent = "";
            $.each(data["data"], function (index, item) {
              titleContent += "    " + item.groupName + "□";
            });
            var line3 = [
              { field: 'workId', title: '编号', rowspan: 2 },
              { field: 'workName', title: '项目名称', rowspan: 2 },
              { field: 'groupName', title: '组别', rowspan: 2 }
            ];
            var line4 = [];
            $.get("/fjaisc/scoreItem/listByProject", { "projectId": projectId }, function (itemData) {
              scoreItem = itemData.data;
              $.each(scoreItem, function (index, item) {
                line3.push({ title: item.itemName, colGroup: true });
                line4.push({ field: 'item' + item.id, title: '满分' + item.maxLimit + '分', align: "center" });
              });
              line3.push({ title: '备注', rowspan: 2 });
              line3.push({ field: 'total', title: '总分', fixed: "right", rowspan: 2 });
              var colspanLen = data.data.length + 5;
              cols = [
                // 第一行{ type: 'checkbox', rowspan: 4, fixed: 'left' },
                [{ title: ' 2020年首届福建省青少年创意编程与智能设计大赛项目评审成绩汇总表', colspan: colspanLen, width: "100%" }],
                // 第二行
                [{ title: titleContent, colspan: colspanLen, width: "100%", align: "center" }],
                // 第三行
                line3,
                line4
              ]
              // console.log(cols);
              var myTable = table.render({
                elem: '#myTable'
                , id: 'myTableId'
                , url: '/fjaisc/works/getJudgeTable'
                , where: { "markTimes": markTimes, "groupId": groupId }
                // <a class="layui-btn layui-btn-sm layui-btn-normal" lay-event="export2"><i class="layui-icon layui-icon-download-circle"></i>导出勾选数据</a>
                , toolbar: '<div><a class="layui-btn" href="/fjaisc/works/exportJudgeTable?projectId=' + projectId + '&groupId=' + groupId + '&markTimes=' + markTimes + '"><i class="layui-icon layui-icon-download-circle"></i>导出汇总表</a></div>'
                // , defaultToolbar: ['print', 'exports']
                , page: false
                , cellMinWidth: 150 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
                // , height: 500
                // 自适应列宽
                // , autoColumnWidth: {
                //   init: true
                // }
                , cols: cols
                , excel: {
                  // filename: '评审成绩汇总表.xlsx',
                  add: {
                    bottom: {
                      data: [
                        ['评委签名：'], // 尾部第一行数据, 中间的空数据是为了 merge 使用
                        ['注：每一页成绩评委均需签名'] //尾部第二行数据，由于我设置了后面的数据merge了，就只写一个
                      ],
                      heights: [, 50,],
                      merge: [['1,2', '1,11'], ['2,1', '2,11']]
                    }
                  }
                }
                , done: function () {
                  soulTable.render(this)
                }
                , parseData: function (res) { //res 即为原始返回的数据
                  return {
                    "code": res.code == 200 ? 0 : -100, //解析接口状态
                    "msg": res.message, //解析提示文本
                    "count": res.data.length, //解析数据长度
                    "data": res.data.map(p => {
                      if (p.scoreDetails) {
                        $.each(p.scoreDetails.scores, function (index, item) {
                          p['item' + item.itemId] = item.score;
                        });
                        p['total'] = p.scoreDetails.totalScore;
                      } else {
                        $.each(scoreItem, function (index, item) {
                          p['item' + item.id] = "未评";
                        });
                      }
                      return p;
                    })//解析数据列表
                  };
                }
              });
              // table.on('toolbar(myTable)', function (obj) {
              //     if (obj.event === 'export') {
              //         table.render({ id: 'myTableId' });
              //         // soulTable.render(myTable.config)
              //         soulTable.export(myTable, {
              //             // 这里的命名会覆盖 excel: { filename: '评审成绩汇总表.xlsx' }中的命名
              //             filename: '导出所有数据.xlsx'
              //         });
              //     }
              //     // else if (obj.event === 'export2') {
              //     //   if (table.checkStatus('myTable').data.length > 0) {
              //     //     soulTable.export(myTable, {
              //     //       filename: '导出勾选数据.xlsx',
              //     //       checked: true // 只导出勾选数据
              //     //     });
              //     //   } else {
              //     //     layer.msg('勾选数据不能为空！');
              //     //   }
              //     // }
              // });
            });
          }
        });
      }
    })
  </script>

</body>

</html>